### Electron中请求拦截与本地缓存图片的处理

#### **背景**

在基于Electron构建的桌面应用中，如何有效缓存网络请求，尤其是图片资源，避免每次加载时重新请求，并提高性能，是常见的需求。本次调研涉及在Electron中使用网络拦截器缓存图片，并通过本地文件缓存减少网络请求。

#### **踩坑点**

1. **缓存文件路径与协议格式问题**

   - **问题**：在Electron中，使用 `file://` 协议拦截本地文件时，路径格式极其严格，必须确保路径正确解码并转换为标准的绝对路径。
   - **解决方案**：在 `protocol.registerFileProtocol` 中解码请求路径并标准化。例如：使用 `path.normalize(decodeURIComponent(url))` 确保路径正确。

2. **路径中的特殊字符（如空格）处理**

   - **问题**：Electron在处理包含空格和其他特殊字符的路径时可能会失败，尤其是在macOS等操作系统中。
   - **解决方案**：使用 `encodeURIComponent` 来编码路径，并确保在 `file://` 协议中返回有效的本地路径。

3. **缓存文件类型不一致**

   - **问题**：图片文件应当根据其实际的 `content-type`（如 `image/png` 或 `image/jpg`）写入带有正确后缀的文件，否则无法在浏览器中正确显示。
   - **解决方案**：根据响应的 `content-type` 确定文件后缀，并在文件名中加上适当的扩展名。可以通过 `getFileExtension(url)` 等函数来动态生成后缀。

4. **缓存文件读取失败**

   - **问题**：即使缓存的文件存在，浏览器也可能无法正确加载，尤其是在缓存路径拼接时未正确处理文件的后缀和协议。
   - **解决方案**：调试时检查缓存路径，并确保缓存文件的内容和格式有效。确保通过 `file://` 协议返回文件时，路径无误。

5. **跨域资源的处理**

   - **问题**：Electron应用中有时需要处理外部资源（如CDN），但是默认情况下会限制跨域请求，导致无法加载远程资源。
   - **解决方案**：需要在 `webPreferences` 中设置 `webSecurity: false` 来禁用安全限制，或者通过 `setWindowOpenHandler` 控制外部链接的打开行为。

6. **缓存无法持久化**
   - **问题**：每次关闭Electron应用后，缓存文件丢失，导致每次启动时需要重新加载资源。
   - **解决方案**：确保缓存存储路径使用了持久化目录（如 `app.getPath('userData')`），不要使用cache目录，并且目录权限没有问题。
